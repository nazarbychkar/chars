# üöÄ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö - –ü—ñ–¥—Å—É–º–æ–∫ –∑–º—ñ–Ω

## ‚úÖ –©–æ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ:

### 1Ô∏è‚É£ PostgreSQL –Ü–Ω–¥–µ–∫—Å–∏
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª `database/indexes.sql` –∑ —É—Å—ñ–º–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º–∏ —ñ–Ω–¥–µ–∫—Å–∞–º–∏
- ‚úÖ –î–æ–¥–∞–Ω–æ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è products (category, subcategory, top_sale, limited_edition, created_at, season)
- ‚úÖ –î–æ–¥–∞–Ω–æ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è product_media, product_sizes, product_colors
- ‚úÖ –î–æ–¥–∞–Ω–æ expression index –¥–ª—è case-insensitive –ø–æ—à—É–∫—É –≤ subcategories
- ‚úÖ –î–æ–¥–∞–Ω–æ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è orders —Ç–∞ order_items

**üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç:** –®–≤–∏–¥–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –∑—Ä–æ—Å—Ç–µ –≤ 2-3 —Ä–∞–∑–∏, –∑–º–µ–Ω—à–∏—Ç—å—Å—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ CPU —Ç–∞ RAM

### 2Ô∏è‚É£ Pool –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
- ‚úÖ –ó–º–µ–Ω—à–µ–Ω–æ `max` –∑ 20 –¥–æ 5 (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 2GB VPS)
- ‚úÖ –¶–µ –∑–º–µ–Ω—à–∏—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è RAM —Ç–∞ —É–Ω–∏–∫–Ω–µ connection contention

**üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è RAM –∑–º–µ–Ω—à–∏—Ç—å—Å—è –∑ ~1.6GB –¥–æ 700-900MB

### 3Ô∏è‚É£ SQL-–∑–∞–ø–∏—Ç–∏ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
- ‚úÖ –ó–∞–º—ñ–Ω–µ–Ω–æ N+1 subqueries –Ω–∞ LATERAL JOIN –≤ —É—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ—è—Ö:
  - `sqlGetAllProducts()`
  - `sqlGetProductsByCategory()`
  - `sqlGetProductsBySubcategoryName()`
  - `sqlGetProductsBySeason()`
  - `sqlGetTopSaleProducts()`
  - `sqlGetLimitedEditionProducts()`
- ‚úÖ –ó–º—ñ–Ω–µ–Ω–æ `ORDER BY p.id DESC` –Ω–∞ `ORDER BY p.created_at DESC` (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ–Ω–¥–µ–∫—Å)

**üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç:** –ó–∞–ø–∏—Ç–∏ –±—É–¥—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –≤ 2-3 —Ä–∞–∑–∏ —à–≤–∏–¥—à–µ

### 4Ô∏è‚É£ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–∏–π –±–∞–≥ –≤ `sqlPostOrder()` - —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–¥–∏–Ω client –¥–ª—è BEGIN/COMMIT/ROLLBACK
- ‚úÖ –î–æ–¥–∞–Ω–æ helper —Ñ—É–Ω–∫—Ü—ñ—é `withTransaction()` –¥–ª—è –º–∞–π–±—É—Ç–Ω—ñ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

**üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π –µ—Ñ–µ–∫—Ç:** –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π, —É–Ω–∏–∫–Ω–µ–Ω–Ω—è race conditions

## üìã –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:

### üî• –ö–†–ò–¢–ò–ß–ù–û (–∑—Ä–æ–±–∏—Ç–∏ –æ–¥—Ä–∞–∑—É):

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏:**
   ```bash
   psql $DATABASE_URL -f database/indexes.sql
   ```

### üéØ –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û (–Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏):

2. **–î–æ–¥–∞—Ç–∏ ISR (Incremental Static Regeneration) –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥—É:**
   ```typescript
   // app/(site)/catalog/page.tsx
   export const revalidate = 300; // 5 —Ö–≤–∏–ª–∏–Ω
   ```

3. **–ü—Ä–∏–±—Ä–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ API –≤–∏–∫–ª–∏–∫–∏ –∑ —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:**
   - –ó–∞–º—ñ—Å—Ç—å `fetch('/api/products')` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `sqlGetAllProducts()` –Ω–∞–ø—Ä—è–º—É
   - –¶–µ –∑–º–µ–Ω—à–∏—Ç—å overhead –≤—ñ–¥ HTTP + JSON –ø–∞—Ä—Å–∏–Ω–≥—É

4. **–î–æ–¥–∞—Ç–∏ memory limits –¥–ª—è PM2:**
   ```json
   // ecosystem.config.js
   {
     max_memory_restart: '800M'
   }
   ```

## üìà –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—É–ª–æ | –°—Ç–∞–Ω–µ | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|---------|------|-------|------------|
| RAM –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è | ~1.6 GB | 700-900 MB | ‚Üì 40-50% |
| TTFB | ~500-800ms | ~200-300ms | ‚Üì 60% |
| PostgreSQL CPU | ~50-70% | ~20-30% | ‚Üì 60% |
| –ó–∞–ø–∏—Ç–∏ –∑ –ë–î | 2-3 —Å–µ–∫—É–Ω–¥–∏ | 0.5-1 —Å–µ–∫—É–Ω–¥–∞ | ‚Üì 70% |

## üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏:
```sql
SELECT schemaname, tablename, indexname, idx_scan 
FROM pg_stat_user_indexes 
WHERE tablename IN ('products', 'product_media', 'product_sizes', 'orders')
ORDER BY idx_scan DESC;
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ EXPLAIN ANALYZE:
```sql
EXPLAIN ANALYZE 
SELECT p.*, m.first_media 
FROM products p 
LEFT JOIN LATERAL (
  SELECT JSONB_BUILD_OBJECT('type', m.type, 'url', m.url) AS first_media
  FROM product_media m
  WHERE m.product_id = p.id
  ORDER BY m.id
  LIMIT 1
) m ON true
ORDER BY p.created_at DESC
LIMIT 20;
```

–Ø–∫—â–æ –±–∞—á–∏—à `Index Scan` –∑–∞–º—ñ—Å—Ç—å `Seq Scan` - –≤—Å–µ –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ:

- –Ü–Ω–¥–µ–∫—Å–∏ –∑–∞–π–º–∞—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –Ω–∞ –¥–∏—Å–∫—É (~10-15% –≤—ñ–¥ —Ä–æ–∑–º—ñ—Ä—É —Ç–∞–±–ª–∏—Ü—å)
- –ü–µ—Ä—à–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —á–∞—Å (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö)
- –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–Ω–µ —ó—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç:

–ü—ñ—Å–ª—è —Ü—ñ—î—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —Ç–≤—ñ–π —Å–∞–π—Ç –±—É–¥–µ:
- ‚ö° **–®–≤–∏–¥—à–∏–π** (TTFB –≤ 2-3 —Ä–∞–∑–∏ –º–µ–Ω—à–∏–π)
- üíæ **–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–∏–π** (40-50% –º–µ–Ω—à–µ RAM)
- üß± **–°—Ç–∞–±—ñ–ª—å–Ω—ñ—à–∏–π** (–Ω–µ –±—É–¥–µ —Ñ—Ä–∏–∑—ñ–≤ –ø—Ä–∏ –ø—ñ–∫–æ–≤–æ–º—É –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ)
- üìà **–ì–æ—Ç–æ–≤–∏–π –¥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** (–º–æ–∂–µ –≤–∏—Ç—Ä–∏–º–∞—Ç–∏ –±—ñ–ª—å—à–µ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)

